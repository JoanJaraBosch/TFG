{% extends 'core/base.html' %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% block title %}{% trans "Monitorització" %}{% endblock %}

{% block background %}{% load static %}{% static 'core/img/monitor-bg.jpg' %}{% endblock %}
{% block headers %}ç
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script type="text/javascript">
var timer_cpu;
var timer_mem; 
var cpu_usage;
var mem;
var graf_cpu;
var graf_mem;

function start_cpu_chart(){

var dps = []; // dataPoints
var chart = new CanvasJS.Chart("chartContainer", {
	title :{
		text: "MONITORING CPU USAGE"
	},
        axisY:{
      	        title: "CPU% usage"
        },
        axisX:{
                title: "Updates"
        },
	data: [{
		type: "line",
		dataPoints: dps
	}]
});

var xVal = 0;
var yVal = 0; 
var updateInterval = 3000;
var dataLength = 10; // number of dataPoints visible at any point

var updateChart = function (count) {

        yVal = cpu_usage;
        dps.push({
		x: xVal,
		y: parseFloat(yVal)
	});
	xVal++;

	if (dps.length > dataLength) {
		dps.shift();
	}

	chart.render();
};

graf_cpu =setInterval(updateChart, updateInterval, dataLength);

};

function start_mem_chart(){

var dps = []; // dataPoints
var chart = new CanvasJS.Chart("chartContainerMem", {
        title :{
                text: "MONITORING RAM AVAILABLE"
        },
        axisY:{
                title: "Memory available"
        },
        axisX:{
                title: "Updates"


        },
        data: [{
                type: "line",
                dataPoints: dps
        }]
});

var xVal = 0;
var yVal = 0; 
var updateInterval_mem = 3000;
var dataLength = 10; // number of dataPoints visible at any point

var updateChart_mem = function (count) {

        yVal = mem;
        dps.push({
                x: xVal,
                y: parseFloat(yVal)
        });
        xVal++;

        if (dps.length > dataLength) {
                dps.shift();
        }

        chart.render();
};

graf_mem =setInterval(updateChart_mem, updateInterval_mem, dataLength);

};

function getting_ips(){
 var ips = {{ ips|safe }};
 var capa = document.getElementById("ips");
 var paso;
 console.log("s'executa la funcio");
 for (paso = 0; paso < ips.length-1; paso++) {
   console.log("entra al bucle");
   var option = document.createElement("option");
   var aux = ips[paso].split(",");
   option.value = aux[1];
   option.innerHTML = aux[1];
   capa.appendChild(option);
 };
};

function monitor_odroid(){
 var capa = document.getElementById("monitor");
 var p = document.createElement("p");
 var select = document.getElementById("ips").value;
 p.innerHTML = "Comencem a fer la connexió per monitorejar la placa ".concat(select);
 capa.appendChild(p);
 if(select==="master"){
    var ip_private = "{{ IP_PRIVATE }}";
    var ws_cpu = new WebSocket("ws://"+ip_private+":3000");
    var ws_mem = new WebSocket("ws://"+ip_private+":3000");
 }
 else{
    var ws_cpu = new WebSocket("ws://"+select+":3000");
    var ws_mem = new WebSocket("ws://"+select+":3000");
 }
 start(ws_cpu, ws_mem);
 start_cpu_chart();
 start_mem_chart();
};

function cpuGlobal(ws){
 console.log("Entro amb linterval");

 ws.send("cpu usage");


 const reader = new FileReader();
 reader.onload = function() {
    console.log(reader.result);
    cpu_usage = reader.result;
    cpu_usage = cpu_usage.split("-");
    cpu_usage = cpu_usage[1];
  };

  ws.onmessage = function(e) {
    reader.readAsText(e.data);
  };

};

function memoriaGlobal(ws){
 console.log("Entro amb linterval");

 ws.send("mem usage");

 const reader_mem = new FileReader();
 reader_mem.onload = function() {
    console.log(reader_mem.result);
    mem = reader_mem.result;
    aux = mem.split("-");
    mem = aux[1]
    mem = mem.replace("G","");
  };

  ws.onmessage = function(e) {
    reader_mem.readAsText(e.data);
  };

};

function start(ws_cpu, ws_mem){
  timer_cpu = setInterval(cpuGlobal, 3000, ws_cpu);
  timer_mem = setInterval(memoriaGlobal, 3000, ws_mem);
};

function stop(){
  if(timer_cpu){
     clearInterval(timer_cpu);
     clearInterval(graf_cpu);
  }

  if(timer_mem){
     clearInterval(timer_mem);
     clearInterval(graf_mem);
  }

};
window.onload = getting_ips;
</script>
<h1>URV-Odroid</h1>
{% endblock %}
{% block content %}
<form>
<select id ="ips" name="select">
<option value="master">master</option>
</select>
<input id="clickMe" type="button" value="Monitoritzar" onclick="monitor_odroid();"/>
</form>
<input id="stopMe" type="button" value="StopMonitoritzar" onclick="stop();"/>
<div id="monitor"></div>
<div id="chartContainer" style="height: 370px; width:100%;"></div>
<div id="chartContainerMem" style="height: 370px; width:100%;"></div>
{% endblock %}
