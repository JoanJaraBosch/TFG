{% extends 'core/base.html' %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% block title %}{% trans "Monitorització" %}{% endblock %}

{% block background %}{% load static %}{% static 'core/img/monitor-bg.jpg' %}{% endblock %}
{% block headers %}
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg==" crossorigin="anonymous"></script>
<script type="text/javascript">
var whoami = 1;
var timer_json;
var cpu_usage;
var mem;
var mem_avail;
var graf_cpu;
var graf_mem;
var graf_mem_avail;
var ws;
var started = 1

function start_cpu_chart(){
var contador = 0;
var ctx = document.getElementById("chartContainer");
var chartCPU = new Chart(ctx, {
        type: "line",
	data: {
        	labels: [],
        	datasets: [{
            		label: 'CPU USAGE',
            		data: [],
		}],
	},
        options: {
                responsive: true,
        	title: {
            		display: true,
           		text: 'Monitoring CPU'
        	},
                scales: {
 			xAxes: [{
               			 scaleLabel: {
                                        display: true,
                                        labelString: 'Updates'
                                }
            		}],
                        yAxes: [{
                                ticks: {
					display: true,
                                        beginAtZero: true,
                                },
				 scaleLabel: {
                                        display: true,
                                        labelString: '% cpu'
                                }

                        }]
                }
        }
});

var updateInterval = 3000;
var dataLength = 10; // number of dataPoints visible at any point

var updateChart = function (count) {
     if(chartCPU.data.datasets[0].data.length==dataLength){
         for(var j = 0; j<dataLength-1; j++){
		chartCPU.data.datasets[0].data[j] = chartCPU.data.datasets[0].data[j+1];
		chartCPU.data.labels[j] = chartCPU.data.labels[j+1];
	 }
        
    	 chartCPU.data.datasets[0].data[chartCPU.data.datasets[0].data.length-1] = parseFloat(cpu_usage);     
     	 chartCPU.data.labels[chartCPU.data.datasets[0].data.length-1] = contador;
     }else{
         chartCPU.data.datasets[0].data[contador] = parseFloat(cpu_usage);
         chartCPU.data.labels[contador] = contador;
     }
     contador+=1;
     chartCPU.update();
};

graf_cpu =setInterval(updateChart, updateInterval, dataLength);

};

function start_mem_avail_chart(){

var contador_mem = 0;
var ctx_mem_avail = document.getElementById("chartContainerMemAvail");
var chartMEMAvail = new Chart(ctx_mem_avail, {
        type: "doughnut",
        data: {
                labels: ['Used', 'Available'],
                datasets: [{
                        data: [],
			backgroundColor: [
                        	'rgba(110, 114, 20, 1)',
                        	'rgba(118, 183, 172, 1)'
                	],
                }],
        },
        options: {
                responsive: true,
		title: {
                        display: true,
                        text: 'Monitoring disk available'
                },
        }
}); 

var updateInterval_mem_avail = 3000;
var dataLength_mem = 10; // number of dataPoints visible at any point

var updateChart_mem_avail = function (count) {
     try{
         chartMEMAvail.data.datasets[0].data[0]= parseFloat(mem_avail[0]);
         chartMEMAvail.data.datasets[0].data[1]= parseFloat(mem_avail[1]);
         chartMEMAvail.update();
     }catch(err){
   
     }
};

graf_mem_avail =setInterval(updateChart_mem_avail, updateInterval_mem_avail, dataLength_mem);


};


function start_mem_chart(){
var contador_mem = 0;
var ctx_mem = document.getElementById("chartContainerMem");
var chartMEM = new Chart(ctx_mem, {
        type: "line",
        data: {
                labels: [],
                datasets: [{
                        label: 'MEM RAM USAGE',
                        data: [],
                }],
        },
        options: {
                responsive: true,
		title: {
			display: true,
			text: 'Monitoring RAM'
		},
                scales: {
			xAxes: [{
				scaleLabel: {
                                        display: true,
	                                labelString: 'Updates'
                                }
			}],
                        yAxes: [{
                                ticks: {
                                        beginAtZero: true
                                },
				scaleLabel: {
					display: true,
					labelString: 'Free MB RAM'
				}
                        }]
                }
        }
});


var updateInterval_mem = 3000;
var dataLength_mem = 10; // number of dataPoints visible at any point

var updateChart_mem = function (count) {
      if(chartMEM.data.labels.length<dataLength_mem){
         chartMEM.data.datasets[0].data[contador_mem] = parseFloat(mem);
         chartMEM.data.labels[contador_mem] = contador_mem;
      }else{

              for(var i =0; i<dataLength_mem-1 ;i++){
                chartMEM.data.datasets[0].data[i] = chartMEM.data.datasets[0].data[i+1];
                chartMEM.data.labels[i] = chartMEM.data.labels[i+1];
              }
              chartMEM.data.datasets[0].data[chartMEM.data.datasets[0].data.length-1] = parseFloat(mem);
              chartMEM.data.labels[chartMEM.data.datasets[0].data.length-1]=contador_mem;
     }
     contador_mem = contador_mem+1;
     chartMEM.update();
};

graf_mem =setInterval(updateChart_mem, updateInterval_mem, dataLength_mem);

};

function getting_ips(){
 var ips = {{ ips|safe }};
 var capa = document.getElementById("ips");
 var paso;
 console.log("s'executa la funcio");
 for (paso = 0; paso < ips.length-1; paso++) {
   console.log("entra al bucle");
   var option = document.createElement("option");
   var aux = ips[paso].split(",");
   option.value = aux[2];
   option.innerHTML = aux[1];
   capa.appendChild(option);
 };
};

function monitor_odroid(){
 if(started == 0){
   stop();
 }else{
   started = 0;
 }
 var capa = document.getElementById("monitor");
 var p = document.createElement("p");
 var select = document.getElementById("ips").value;
 p.innerHTML = "Comencem a fer la connexió per monitorejar la placa.";
 capa.appendChild(p);
 var ip_private = "{{ IP_PRIVATE }}";
 ws = new WebSocket("wss://"+ip_private+":3000");
 console.log(ws);
 ws.onerror = function(evt) {
        alert("Hi ha un error amb el servidor node la placa master. Iniceu-lo o reinicieu-lo amb forever start/restart servidor.js");
 };

 ws.onopen = function() {
      console.log('connected');
      start(ws, select);
      start_cpu_chart();
      start_mem_chart();
      start_mem_avail_chart();
};
};
var cpu_boolean = 0;
function jsonGlobal(ws, select){
 console.log("Entro amb linterval");
 
 if(whoami==1){
  ws.send(select);
  whoami=0;
 }
 ws.send("json test");

 const reader = new FileReader();
 reader.onload = function() {
    console.log(reader.result);
    json_message = JSON.parse(reader.result);
    cpu_usage = json_message.cpu;
    mem_avail = json_message.mem_avail;
    mem_avail = mem_avail.split(" ");
    mem = json_message.mem;
    console.log('CPU: '+cpu_usage);
  };

  ws.onmessage = function(e) {
    console.log('json resposta: '+e.data);
    reader.readAsText(e.data);
  };

};

function start(ws, select){
  timer_json = setInterval(jsonGlobal, 3000,ws, select);
};

function stop(){
  if(timer_json){
     clearInterval(timer_json);
     clearInterval(graf_cpu);
     clearInterval(graf_mem);
     clearInterval(graf_mem_avail);
  }
  
  ws.close();
  whoami=1;
};
window.onload = getting_ips;
</script>
<h1>URV-Odroid</h1>
{% endblock %}
{% block content %}
<form>
<select id ="ips" name="select">
<option value="master">master</option>
</select>
<input id="clickMe" type="button" value="Monitoritzar" onclick="monitor_odroid();"/>
</form>
<input id="stopMe" type="button" value="StopMonitoritzar" onclick="stop();"/>
<div id="monitor"></div>
<canvas id="chartContainer" style="height: 370px; width:100%;"></canvas>
<canvas id="chartContainerMem" style="height: 370px; width:100%;"></canvas>
<canvas id="chartContainerMemAvail" style="height: 370px; width:100%;"></canvas>
{% endblock %}
